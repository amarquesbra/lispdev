Deep refactoring of Cusp plugin.